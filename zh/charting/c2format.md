# Cytus II 谱面格式详解

本文旨在解释 Cytus II 的谱面格式。通过阅读本文，您可以了解谱面数据的组织方式。需要注意的是，并非所有 Cytus II / Cytoid 制谱器都使用了相同的概念，但我们建议在制谱前先了解该格式，以知悉谱面本身可以实现何种效果。

Cytus II 谱面文件采用 [JSON](https://en.wikipedia.org/wiki/JSON) 格式，可以使用任何文本编辑器进行编写。本文将会对谱面文件中的概念以及出现的所有属性进行详细解释。

## 概念

以下会介绍谱面格式设计的各个概念，先了解概念有助于理解该格式。

### 基础

- 整型数 `int` ：整数的有限子集。最大值为 `2147483647` ，最小值为 `-2147483648` 。
- 布尔值 `bool` ：仅有两个取值，分别为 `true` 是和 `false` 否。
- 双精度浮点数 `double` ：小数。

### 时间

- Tick ：Tick 是 Cytus II 谱面采用的重要单位，它用于对元素进行时间定位。
- TimeBase ：时基。表示一拍子的 Tick 长度。
- Tempo ：速度。表示一拍子的持续时间。
  - 需要注意要将 Tempo 与我们熟知的 BPM 区分开，BPM 的含义是每分钟小拍数。因此 Tempo 和 BPM 存在转换关系 
  $$ \text{Tempo}=60,000,000 \div \text{BPM}$$
  其中 60,000,000 指的是一分钟的微秒长度。**建议不要将 BPM 这一概念代入来理解**。
- 换算
  - Tick 不能独立决定时间尺度，它需要结合时基和速度进行计算。
  - 通过例子来理解：假设从第 0 Tick 开始，TimeBase 是 480 ，Tempo 是 500,000 ，那么我们试求第 1,200 Tick 对应的时间：
  $$ 1,200\div480 \times 500,000 = 1,250,000 \text{ μs} = 1,250 \text{ ms}$$
  结果是 1,250 毫秒。
    - 对该计算再进行剖析：根据前文提到 TimeBase 含义，$1,200 \div 480 = 2.5$ ，即第 1,200 Tick 对应第 2.5 拍。再结合 Tempo 每拍时长，就能通过 $2.5\times500,000$ 求出该 Tick 求出对应时间。
  

## 文件结构

### 根结构

- `format_version` ：格式版本。取任意整型数字。
  - 无实际作用，不会对谱面造成影响。
  - 现阶段 Cytus II 官方（以下官方均指 Cytus II 官方）对该值取 `1` 。
- `time_base` ：时基。取任意正整型数。
  - 现阶段官方从未修改该数值，保持为 `480` 。
- `start_offset_time` ：开始时间。取任意非负浮点数。该值表示游玩时**谱面和音乐均**从何时开始。
  - 现阶段官方从未使用该数值，保持为 `0.0` 。
  - 该值在 Cytoid 无效，同时需要将它和 Cytoid 的特有属性 `music_offset` 区分开。
- `end_offset_time` ：提前结束时间。取任意浮点数。该值表示游玩时提前多长时间结束。
  - 现阶段官方从未使用该数值，保持为 `0.0` 。
  - 该值在 Cytoid 无效。
- `is_start_without_ui` ：以无 UI 状态开始游戏。取布尔值。该值若为 `true` ，那么开始游玩时界面不会出现任何 UI (Gameplay UI)。
  - 该值在 Cytoid 无效。
- `page_list` ：页面列表。
- `tempo_list` ：速度列表。
- `event_order_list` ：事件列表。
- `note_list` ：拍点列表。

### 页面

- `start_tick` ：页面起始 Tick。表示页面始端是第几 Tick 。取非负整型数。
- `end_tick` ：页面结束 Tick。表示页面末端是第几 Tick 。取非负整型数。
  - 原则上，页面序列具有连续性，即上一页的 `end_tick` 应为下一页的 `start_tick` 。但在 Cytoid 中，会出现将 `start_tick` 设置为负数的独特用法，该用法在 Cytus II 中会出现异常。
- `scan_line_direction` ：扫描线方向。取值有 `1` 表示从下往上，表示从上往下。
  - 在 Cytoid 中，该值可以设置为 `1` 和 `-1` 以外的数值并且有相应效果，但 Cytus II 不支持其他数值。
- `PositionFunction` ：页面函数。
  - `Type` ：函数类型。当前只有取值 `0` 。
  - `Arguments` ：函数参数。取值为双精度浮点数数组。原则上该数组包含两个双精度浮点数。
    - 参数 1 ：页面缩放倍率。指页面以一半的高度为中心缩放的倍率。
      - 默认值应为 `1.0` ，表示 1 倍缩放。
      - 页面被缩放后，所有拍点的位置会发生移动，扫描线也仅在该高度范围内运行。
      - 在官方的下落式谱面中，会将该值设置为 `0` 即 0 倍缩放，来使扫描线在下落式的页面中完全静止不动。
    - 参数 2 ：页面偏移。指页面的纵向位置偏移。
      - 该值以半个原始页面高度为一个单位。如果该值设置 `1.0` ，页面会往上偏移半个原始页面高度， `-1.0` 则往下。默认值为 `0.0` 。
  - 该值当前只出现在官方的 Alice 和 Hans 曲包带有下落式配置的谱面中。Cytoid 不支持该值。
___
作者：Horiztar

施工未完成
